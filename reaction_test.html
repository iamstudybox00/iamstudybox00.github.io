<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>순발력 테스트 게임</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', 'Pretendard', -apple-system, sans-serif;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(120deg, #667eea 0%, #764ba2 100%);
    }

    #game-container {
      position: relative;
      width: 800px;
      height: 600px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 30px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      transition: background 0.3s ease;
    }

    /* 게임 화면 상태별 배경 */
    #game-container.waiting {
      background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    }

    #game-container.signal {
      background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
    }

    /* 모달 공통 스타일 */
    .modal {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #fff, #f5f5f5);
      padding: 50px 60px;
      border-radius: 25px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      text-align: center;
      max-width: 500px;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-title {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #667eea;
    }

    .modal-subtitle {
      font-size: 1.2em;
      color: #7f8c8d;
      margin-bottom: 30px;
    }

    /* 버튼 스타일 */
    .btn {
      font-size: 1.2em;
      padding: 15px 40px;
      border-radius: 15px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #7f8c8d;
    }

    .btn-disabled {
      background: #e0e0e0;
      color: #bbb;
      cursor: not-allowed;
    }

    /* 모드 선택 버튼 */
    .mode-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 30px 0;
    }

    .mode-btn {
      width: 100%;
      padding: 20px;
      font-size: 1.1em;
      border-radius: 15px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .mode-btn:not(.active) {
      background: #e0e0e0;
      color: #7f8c8d;
    }

    .mode-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    /* 최고 기록 표시 */
    .best-record {
      background: rgba(255, 239, 133, 0.3);
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
    }

    .best-record-label {
      font-size: 0.9em;
      color: #7f8c8d;
      margin-bottom: 5px;
    }

    .best-record-value {
      font-size: 2em;
      font-weight: bold;
      color: #ff6a88;
      font-family: 'Consolas', monospace;
    }

    /* 게임 화면 */
    #game-screen {
      display: none;
      width: 100%;
      height: 100%;
      position: relative;
      cursor: pointer;
    }

    #game-screen.active {
      display: block;
    }

    /* 상단 정보 바 */
    .game-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
      font-weight: bold;
      z-index: 10;
    }

    .round-info {
      font-size: 1.2em;
    }

    .game-controls {
      display: flex;
      gap: 10px;
    }

    .game-control-btn {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
      color: #fff;
      font-weight: bold;
      font-size: 0.95em;
    }

    .game-control-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* 중앙 메시지 */
    .center-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
      width: 100%;
      padding: 0 40px;
    }

    .main-text {
      font-size: 4em;
      font-weight: bold;
      margin-bottom: 20px;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .signal-text {
      font-size: 5em;
      font-weight: bold;
      text-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      animation: signalPulse 0.5s ease-in-out;
    }

    @keyframes signalPulse {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    .sub-text {
      font-size: 1.1em;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.6;
    }

    /* 이전 기록 표시 */
    .records-box {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.2);
      padding: 20px 40px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      color: #fff;
      min-width: 300px;
    }

    .records-title {
      font-size: 1em;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }

    .record-item {
      font-family: 'Consolas', monospace;
      font-size: 0.95em;
      margin: 5px 0;
      text-align: center;
    }

    /* 결과 화면 */
    .result-content {
      padding: 20px;
    }

    .result-title {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 20px;
    }

    .avg-time-label {
      font-size: 1.1em;
      color: #7f8c8d;
      margin-bottom: 10px;
    }

    .avg-time-value {
      font-size: 4em;
      font-weight: bold;
      color: #ff6a88;
      font-family: 'Consolas', monospace;
      margin-bottom: 20px;
      animation: countUp 0.5s ease;
    }

    @keyframes countUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .grade-badge {
      display: inline-block;
      padding: 15px 50px;
      border-radius: 15px;
      font-size: 2em;
      font-weight: bold;
      color: #fff;
      margin: 20px 0;
      animation: gradeAppear 0.5s ease 0.3s both;
    }

    @keyframes gradeAppear {
      from { 
        opacity: 0; 
        transform: scale(0.5) rotate(-10deg); 
      }
      to { 
        opacity: 1; 
        transform: scale(1) rotate(0deg); 
      }
    }

    .grade-S { background: linear-gradient(135deg, #f093fb, #f5576c); }
    .grade-A { background: linear-gradient(135deg, #2ed573, #26de81); }
    .grade-B { background: linear-gradient(135deg, #4facfe, #00f2fe); }
    .grade-C { background: linear-gradient(135deg, #fa709a, #fee140); }
    .grade-D { background: linear-gradient(135deg, #a8a8a8, #7f7f7f); }

    .stars {
      font-size: 2em;
      margin: 10px 0;
    }

    .detailed-records {
      background: rgba(102, 126, 234, 0.1);
      padding: 25px;
      border-radius: 15px;
      margin: 25px 0;
    }

    .detailed-records-title {
      font-size: 1em;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .detailed-records-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .detailed-record-item {
      font-family: 'Consolas', monospace;
      font-size: 0.95em;
      color: #2c3e50;
      text-align: left;
    }

    /* 에러 모달 */
    .error-modal .modal-content {
      background: linear-gradient(135deg, #fff, #ffe8e8);
    }

    .error-title {
      font-size: 2em;
      font-weight: bold;
      color: #ff4757;
      margin-bottom: 20px;
    }

    .error-message {
      font-size: 1.1em;
      color: #7f8c8d;
      line-height: 1.8;
      margin-bottom: 30px;
    }

    /* 일시정지 모달 */
    .pause-modal .modal-content {
      background: linear-gradient(135deg, #fff, #e8f4ff);
    }

    .pause-title {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 30px;
    }

    .pause-info {
      font-size: 1.1em;
      color: #7f8c8d;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    /* 클릭 효과 */
    #game-container.clicked {
      animation: clickFlash 0.3s ease;
    }

    @keyframes clickFlash {
      0% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
      100% { filter: brightness(1); }
    }

    /* 숫자 순서 모드 */
    .number-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    .number-container.active {
      display: block;
    }

    .number-item {
      position: absolute;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      user-select: none;
    }

    .number-item:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    .number-item.clicked {
      background: linear-gradient(135deg, #2ed573, #26de81);
      animation: numberPop 0.3s ease;
      pointer-events: none;
    }

    .number-item.wrong {
      background: linear-gradient(135deg, #ff4757, #ff6348);
      animation: shake 0.3s ease;
    }

    @keyframes numberPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(0); opacity: 0; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .number-info {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.3);
      padding: 15px 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      z-index: 10;
    }

    /* 타이밍 모드 */
    .timing-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    .timing-container.active {
      display: block;
    }

    .timing-bar-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 600px;
      height: 80px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 40px;
      overflow: hidden;
      border: 3px solid rgba(255, 255, 255, 0.5);
    }

    .timing-target-zone {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 100%;
      background: rgba(46, 213, 115, 0.5);
      border-left: 3px solid #2ed573;
      border-right: 3px solid #2ed573;
    }

    .timing-bar {
      position: absolute;
      top: 0;
      left: 0;
      width: 40px;
      height: 100%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
      animation: moveBar 2s linear infinite;
    }

    @keyframes moveBar {
      0% { left: 0; }
      50% { left: calc(100% - 40px); }
      100% { left: 0; }
    }

    .timing-bar.paused {
      animation-play-state: paused;
    }

    .timing-info {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.3);
      padding: 15px 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      z-index: 10;
      text-align: center;
    }

    .timing-score-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4em;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
    }

    .timing-score-display.show {
      animation: scoreShow 1s ease;
    }

    @keyframes scoreShow {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }

    .timing-instruction {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-size: 1.2em;
      text-align: center;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    /* 반응형 디자인 */
    @media (max-width: 900px) {
      #game-container {
        width: 90vw;
        height: 70vh;
        min-height: 500px;
      }

      .modal-content {
        padding: 30px 40px;
        max-width: 90%;
      }

      .modal-title {
        font-size: 2em;
      }

      .main-text {
        font-size: 3em;
      }

      .signal-text {
        font-size: 4em;
      }

      .avg-time-value {
        font-size: 3em;
      }
    }

    @media (max-width: 600px) {
      #game-container {
        width: 95vw;
        height: 80vh;
      }

      .modal-content {
        padding: 25px 30px;
      }

      .modal-title {
        font-size: 1.8em;
      }

      .btn {
        font-size: 1em;
        padding: 12px 30px;
      }

      .main-text {
        font-size: 2.5em;
      }

      .signal-text {
        font-size: 3.5em;
      }

      .game-header {
        padding: 15px 20px;
      }

      .round-info {
        font-size: 1em;
      }

      .records-box {
        padding: 15px 25px;
        min-width: 250px;
      }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <!-- 시작 모달 -->
    <div id="start-modal" class="modal active">
      <div class="modal-content">
        <div class="modal-title">🎯 순발력 테스트</div>
        <div class="modal-subtitle">당신의 반응 속도는?</div>
        
        <div class="mode-buttons">
          <button class="mode-btn active" data-mode="classic">클래식 모드</button>
          <button class="mode-btn" data-mode="number">숫자 순서 모드</button>
          <button class="mode-btn" data-mode="timing">타이밍 모드</button>
        </div>

        <div class="best-record">
          <div class="best-record-label">최고 기록</div>
          <div class="best-record-value" id="best-record-display">---</div>
        </div>

        <button class="btn btn-primary" id="start-btn">게임 시작</button>
      </div>
    </div>

    <!-- 게임 화면 -->
    <div id="game-screen">
      <div class="game-header">
        <div class="round-info" id="round-info">라운드: 1/5</div>
        <div class="game-controls">
          <button class="game-control-btn" id="pause-btn">⏸ 일시정지</button>
          <button class="game-control-btn" id="menu-btn">🏠 메뉴</button>
          <button class="game-control-btn" id="restart-btn">⟳ 재시작</button>
        </div>
      </div>

      <div class="center-message" id="center-message">
        <div class="main-text" id="main-text">준비...</div>
        <div class="sub-text" id="sub-text">화면이 빨간색으로<br>변하면 클릭하세요!</div>
      </div>

      <div class="records-box" id="records-box" style="display: none;">
        <div class="records-title">이전 기록:</div>
        <div id="records-list"></div>
      </div>

      <!-- 숫자 순서 모드 -->
      <div class="number-container" id="number-container">
        <div class="number-info" id="number-info">다음 숫자: 1</div>
      </div>

      <!-- 타이밍 모드 -->
      <div class="timing-container" id="timing-container">
        <div class="timing-info" id="timing-info">라운드: 1/10</div>
        <div class="timing-bar-container">
          <div class="timing-target-zone"></div>
          <div class="timing-bar" id="timing-bar"></div>
        </div>
        <div class="timing-score-display" id="timing-score-display">100점!</div>
        <div class="timing-instruction">바가 초록색 영역에 있을 때 클릭하세요!</div>
      </div>
    </div>

    <!-- 결과 모달 -->
    <div id="result-modal" class="modal">
      <div class="modal-content">
        <div class="result-content">
          <div class="result-title">게임 완료! 🎉</div>
          <div class="avg-time-label" id="avg-time-label">평균 반응 속도</div>
          <div class="avg-time-value" id="avg-time">---</div>
          
          <div class="grade-badge" id="grade-badge">등급: -</div>
          <div class="stars" id="stars">⭐⭐⭐⭐⭐</div>

          <div class="detailed-records">
            <div class="detailed-records-title">상세 기록:</div>
            <div class="detailed-records-grid" id="detailed-records"></div>
          </div>

          <div>
            <button class="btn btn-primary" id="retry-btn">다시하기</button>
            <button class="btn btn-secondary" id="main-btn">메인으로</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 에러 모달 -->
    <div id="error-modal" class="modal error-modal">
      <div class="modal-content">
        <div class="error-title">⚠️ 너무 빨라요!</div>
        <div class="error-message">
          색상이 변하기 전에<br>
          클릭하셨습니다.<br>
          다시 시도하세요!
        </div>
        <button class="btn btn-primary" id="error-retry-btn">다시 시도</button>
      </div>
    </div>

    <!-- 일시정지 모달 -->
    <div id="pause-modal" class="modal pause-modal">
      <div class="modal-content">
        <div class="pause-title">⏸ 일시정지</div>
        <div class="pause-info">
          게임이 일시정지되었습니다.<br>
          계속하시겠습니까?
        </div>
        <div>
          <button class="btn btn-primary" id="resume-btn">계속하기</button>
          <button class="btn btn-secondary" id="pause-menu-btn">메인으로</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 게임 상태 관리
    const gameState = {
      mode: 'classic',
      round: 0,
      maxRounds: 5,
      records: [],
      waiting: false,
      canClick: false,
      startTime: 0,
      waitTimeout: null,
      signalTimeout: null,
      paused: false,
      pausedTime: 0,
      // 숫자 순서 모드
      numberCount: 10,
      currentNumber: 1,
      numberStartTime: 0,
      numbers: [],
      // 타이밍 모드
      timingRound: 0,
      timingMaxRounds: 10,
      timingScores: []
    };

    // DOM 요소
    const elements = {
      container: document.getElementById('game-container'),
      startModal: document.getElementById('start-modal'),
      gameScreen: document.getElementById('game-screen'),
      resultModal: document.getElementById('result-modal'),
      errorModal: document.getElementById('error-modal'),
      pauseModal: document.getElementById('pause-modal'),
      startBtn: document.getElementById('start-btn'),
      retryBtn: document.getElementById('retry-btn'),
      mainBtn: document.getElementById('main-btn'),
      restartBtn: document.getElementById('restart-btn'),
      pauseBtn: document.getElementById('pause-btn'),
      menuBtn: document.getElementById('menu-btn'),
      resumeBtn: document.getElementById('resume-btn'),
      pauseMenuBtn: document.getElementById('pause-menu-btn'),
      errorRetryBtn: document.getElementById('error-retry-btn'),
      roundInfo: document.getElementById('round-info'),
      centerMessage: document.getElementById('center-message'),
      mainText: document.getElementById('main-text'),
      subText: document.getElementById('sub-text'),
      recordsBox: document.getElementById('records-box'),
      recordsList: document.getElementById('records-list'),
      bestRecordDisplay: document.getElementById('best-record-display'),
      avgTime: document.getElementById('avg-time'),
      avgTimeLabel: document.getElementById('avg-time-label'),
      gradeBadge: document.getElementById('grade-badge'),
      stars: document.getElementById('stars'),
      detailedRecords: document.getElementById('detailed-records'),
      // 숫자 순서 모드
      numberContainer: document.getElementById('number-container'),
      numberInfo: document.getElementById('number-info'),
      // 타이밍 모드
      timingContainer: document.getElementById('timing-container'),
      timingInfo: document.getElementById('timing-info'),
      timingBar: document.getElementById('timing-bar'),
      timingScoreDisplay: document.getElementById('timing-score-display')
    };

    // 모드 선택 버튼
    const modeButtons = document.querySelectorAll('.mode-btn');
    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        modeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        gameState.mode = btn.dataset.mode;
      });
    });

    // localStorage 관리
    function getBestRecord() {
      const record = localStorage.getItem('reactionTestBestRecord');
      return record ? parseInt(record) : null;
    }

    function saveBestRecord(time) {
      const current = getBestRecord();
      if (!current || time < current) {
        localStorage.setItem('reactionTestBestRecord', time);
        return true;
      }
      return false;
    }

    function displayBestRecord() {
      const best = getBestRecord();
      elements.bestRecordDisplay.textContent = best ? `${best}ms` : '---';
    }

    // 게임 시작
    function startGame() {
      gameState.round = 0;
      gameState.records = [];
      gameState.paused = false;
      gameState.waiting = false;
      gameState.canClick = false;
      
      elements.startModal.classList.remove('active');
      elements.gameScreen.classList.add('active');
      
      // 모드별 초기화
      if (gameState.mode === 'classic') {
        elements.centerMessage.style.display = 'block';
        elements.numberContainer.classList.remove('active');
        elements.timingContainer.classList.remove('active');
        startRound();
      } else if (gameState.mode === 'number') {
        elements.centerMessage.style.display = 'none';
        elements.numberContainer.classList.add('active');
        elements.timingContainer.classList.remove('active');
        startNumberMode();
      } else if (gameState.mode === 'timing') {
        elements.centerMessage.style.display = 'none';
        elements.numberContainer.classList.remove('active');
        elements.timingContainer.classList.add('active');
        startTimingMode();
      }
    }

    // 라운드 시작
    function startRound() {
      gameState.round++;
      gameState.canClick = false;
      gameState.waiting = true;

      // UI 업데이트
      elements.roundInfo.textContent = `라운드: ${gameState.round}/${gameState.maxRounds}`;
      elements.container.className = 'waiting';
      elements.mainText.textContent = '준비...';
      elements.mainText.className = 'main-text';
      elements.subText.style.display = 'block';
      elements.subText.innerHTML = '화면이 빨간색으로<br>변하면 클릭하세요!';

      // 이전 기록 표시
      if (gameState.records.length > 0) {
        elements.recordsBox.style.display = 'block';
        elements.recordsList.innerHTML = gameState.records
          .map((time, idx) => `<div class="record-item">${idx + 1}회: ${time}ms</div>`)
          .join('');
      }

      // 랜덤 대기 시간 (2-5초)
      const waitTime = 2000 + Math.random() * 3000;
      
      gameState.waitTimeout = setTimeout(() => {
        showSignal();
      }, waitTime);
    }

    // 시작 신호 표시
    function showSignal() {
      gameState.waiting = false;
      gameState.canClick = true;
      gameState.startTime = Date.now();

      elements.container.className = 'signal';
      elements.mainText.textContent = '지금!!!';
      elements.mainText.className = 'signal-text';
      elements.subText.style.display = 'none';

      // 5초 타임아웃
      gameState.signalTimeout = setTimeout(() => {
        handleTimeout();
      }, 5000);
    }

    // 클릭 처리
    function handleClick(event) {
      // 일시정지 상태면 무시
      if (gameState.paused) return;

      // 타이밍 모드일 때
      if (gameState.mode === 'timing' && elements.timingContainer.classList.contains('active')) {
        handleTimingClick();
        return;
      }

      // 숫자 순서 모드는 숫자 클릭으로만 처리
      if (gameState.mode === 'number') {
        return;
      }

      // 클래식 모드
      // 클릭 효과 추가
      addClickEffect();

      // 대기 중일 때 클릭 (너무 빠른 클릭)
      if (gameState.waiting) {
        clearTimeout(gameState.waitTimeout);
        showError();
        return;
      }

      // 클릭 가능 상태일 때
      if (gameState.canClick) {
        const reactionTime = Date.now() - gameState.startTime;
        gameState.canClick = false;
        clearTimeout(gameState.signalTimeout);

        // 기록 저장
        gameState.records.push(reactionTime);

        // 다음 라운드 또는 결과 표시
        if (gameState.round < gameState.maxRounds) {
          setTimeout(() => {
            startRound();
          }, 800);
        } else {
          setTimeout(() => {
            showResult();
          }, 800);
        }
      }
    }

    // 클릭 효과 추가
    function addClickEffect() {
      // 배경색 변경 효과
      const colors = [
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
      ];
      
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      const currentClass = elements.container.className;
      
      // 임시로 배경색 변경
      elements.container.style.background = randomColor;
      elements.container.classList.add('clicked');
      
      setTimeout(() => {
        elements.container.classList.remove('clicked');
        // 원래 상태로 복원
        if (currentClass.includes('waiting')) {
          elements.container.style.background = '';
        } else if (currentClass.includes('signal')) {
          elements.container.style.background = '';
        }
      }, 300);
    }

    // 에러 표시 (너무 빠른 클릭)
    function showError() {
      elements.errorModal.classList.add('active');
    }

    // 에러 모달에서 재시도
    function retryAfterError() {
      elements.errorModal.classList.remove('active');
      startRound();
    }

    // 타임아웃 처리
    function handleTimeout() {
      gameState.canClick = false;
      gameState.records.push(9999);

      if (gameState.round < gameState.maxRounds) {
        elements.mainText.textContent = '시간 초과!';
        setTimeout(() => {
          startRound();
        }, 1500);
      } else {
        setTimeout(() => {
          showResult();
        }, 1500);
      }
    }

    // 결과 표시
    function showResult() {
      elements.gameScreen.classList.remove('active');
      elements.container.className = '';

      if (gameState.mode === 'classic') {
        showClassicResult();
      } else if (gameState.mode === 'number') {
        showNumberResult();
      } else if (gameState.mode === 'timing') {
        showTimingResult();
      }
    }

    // 클래식 모드 결과
    function showClassicResult() {
      // 평균 계산 (9999 제외)
      const validRecords = gameState.records.filter(time => time < 9999);
      const avgTime = validRecords.length > 0 
        ? Math.round(validRecords.reduce((a, b) => a + b, 0) / validRecords.length)
        : 9999;

      // 등급 계산
      const grade = calculateGrade(avgTime);
      const stars = getStars(grade);

      // UI 업데이트
      elements.avgTime.textContent = `${avgTime}ms`;
      elements.avgTimeLabel.textContent = '평균 반응 속도';
      elements.gradeBadge.textContent = `등급: ${grade}`;
      elements.gradeBadge.className = `grade-badge grade-${grade}`;
      elements.stars.textContent = stars;

      // 상세 기록
      elements.detailedRecords.innerHTML = gameState.records
        .map((time, idx) => {
          const displayTime = time === 9999 ? '시간초과' : `${time}ms`;
          return `<div class="detailed-record-item">${idx + 1}회: ${displayTime}</div>`;
        })
        .join('');

      // 최고 기록 저장
      if (avgTime < 9999) {
        const isNewRecord = saveBestRecord(avgTime);
        if (isNewRecord) {
          displayBestRecord();
        }
      }

      elements.resultModal.classList.add('active');
    }

    // 숫자 순서 모드 결과
    function showNumberResult() {
      const totalTime = gameState.records[0];
      const avgTimePerNumber = Math.round(totalTime / gameState.numberCount);

      // 등급 계산 (숫자당 평균 시간 기준)
      let grade;
      if (avgTimePerNumber < 500) grade = 'S';
      else if (avgTimePerNumber < 700) grade = 'A';
      else if (avgTimePerNumber < 1000) grade = 'B';
      else if (avgTimePerNumber < 1500) grade = 'C';
      else grade = 'D';

      const stars = getStars(grade);

      // UI 업데이트
      elements.avgTime.textContent = `${(totalTime / 1000).toFixed(2)}초`;
      elements.avgTimeLabel.textContent = '완료 시간';
      elements.gradeBadge.textContent = `등급: ${grade}`;
      elements.gradeBadge.className = `grade-badge grade-${grade}`;
      elements.stars.textContent = stars;

      // 상세 기록
      elements.detailedRecords.innerHTML = `
        <div class="detailed-record-item">총 시간: ${(totalTime / 1000).toFixed(2)}초</div>
        <div class="detailed-record-item">숫자 개수: ${gameState.numberCount}개</div>
        <div class="detailed-record-item">평균: ${avgTimePerNumber}ms/개</div>
      `;

      elements.resultModal.classList.add('active');
    }

    // 타이밍 모드 결과
    function showTimingResult() {
      const totalScore = gameState.timingScores.reduce((a, b) => a + b, 0);
      const avgScore = Math.round(totalScore / gameState.timingScores.length);

      // 등급 계산 (평균 점수 기준)
      let grade;
      if (avgScore >= 90) grade = 'S';
      else if (avgScore >= 75) grade = 'A';
      else if (avgScore >= 60) grade = 'B';
      else if (avgScore >= 40) grade = 'C';
      else grade = 'D';

      const stars = getStars(grade);

      // UI 업데이트
      elements.avgTime.textContent = `${avgScore}점`;
      elements.avgTimeLabel.textContent = '평균 정확도';
      elements.gradeBadge.textContent = `등급: ${grade}`;
      elements.gradeBadge.className = `grade-badge grade-${grade}`;
      elements.stars.textContent = stars;

      // 상세 기록
      elements.detailedRecords.innerHTML = gameState.timingScores
        .map((score, idx) => {
          return `<div class="detailed-record-item">${idx + 1}회: ${score}점</div>`;
        })
        .join('');

      elements.resultModal.classList.add('active');
    }

    // 등급 계산
    function calculateGrade(avgTime) {
      if (avgTime < 200) return 'S';
      if (avgTime < 250) return 'A';
      if (avgTime < 300) return 'B';
      if (avgTime < 400) return 'C';
      return 'D';
    }

    // 별 개수
    function getStars(grade) {
      const starMap = { 'S': '⭐⭐⭐⭐⭐', 'A': '⭐⭐⭐⭐', 'B': '⭐⭐⭐', 'C': '⭐⭐', 'D': '⭐' };
      return starMap[grade] || '⭐';
    }

    // 재시작
    function restart() {
      elements.resultModal.classList.remove('active');
      
      // 숫자 모드 정리
      const existingNumbers = elements.numberContainer.querySelectorAll('.number-item');
      existingNumbers.forEach(num => num.remove());
      
      // 타이밍 바 정리
      elements.timingBar.style.animation = 'none';
      elements.timingBar.classList.remove('paused');
      
      startGame();
    }

    // 메인으로
    function goToMain() {
      elements.resultModal.classList.remove('active');
      elements.gameScreen.classList.remove('active');
      elements.container.className = '';
      elements.startModal.classList.add('active');
      elements.recordsBox.style.display = 'none';
      elements.centerMessage.style.display = 'block';
      elements.numberContainer.classList.remove('active');
      elements.timingContainer.classList.remove('active');
      
      // 상태 초기화
      gameState.paused = false;
      gameState.waiting = false;
      gameState.canClick = false;
      
      // 숫자 모드 정리
      const existingNumbers = elements.numberContainer.querySelectorAll('.number-item');
      existingNumbers.forEach(num => num.remove());
      
      // 타이밍 바 정리
      elements.timingBar.style.animation = 'none';
      elements.timingBar.classList.remove('paused');
    }

    // ========== 숫자 순서 모드 ==========
    function startNumberMode() {
      gameState.currentNumber = 1;
      gameState.numberStartTime = Date.now();
      gameState.numbers = [];
      gameState.paused = false;
      
      elements.container.className = 'waiting';
      elements.roundInfo.textContent = `숫자 개수: ${gameState.numberCount}개`;
      
      // 기존 숫자들 제거
      const existingNumbers = elements.numberContainer.querySelectorAll('.number-item');
      existingNumbers.forEach(num => num.remove());
      
      // 숫자 생성
      for (let i = 1; i <= gameState.numberCount; i++) {
        const number = document.createElement('div');
        number.className = 'number-item';
        number.textContent = i;
        number.dataset.number = i;
        
        // 랜덤 위치 (겹치지 않게)
        let x, y, overlapping;
        let attempts = 0;
        do {
          overlapping = false;
          x = 80 + Math.random() * (elements.container.offsetWidth - 160);
          y = 150 + Math.random() * (elements.container.offsetHeight - 250);
          
          // 다른 숫자와 겹치는지 확인
          for (let existing of gameState.numbers) {
            const dx = x - existing.x;
            const dy = y - existing.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < 80) {
              overlapping = true;
              break;
            }
          }
          attempts++;
        } while (overlapping && attempts < 50);
        
        number.style.left = x + 'px';
        number.style.top = y + 'px';
        
        gameState.numbers.push({ x, y, element: number });
        
        number.addEventListener('click', (e) => {
          e.stopPropagation();
          handleNumberClick(parseInt(number.dataset.number), number);
        });
        
        elements.numberContainer.appendChild(number);
      }
      
      updateNumberInfo();
    }

    function handleNumberClick(number, element) {
      if (gameState.paused) return;
      
      if (number === gameState.currentNumber) {
        // 정답
        element.classList.add('clicked');
        gameState.currentNumber++;
        
        if (gameState.currentNumber > gameState.numberCount) {
          // 완료
          const totalTime = Date.now() - gameState.numberStartTime;
          gameState.records.push(totalTime);
          
          setTimeout(() => {
            showResult();
          }, 500);
        } else {
          updateNumberInfo();
        }
      } else {
        // 오답
        element.classList.add('wrong');
        setTimeout(() => {
          element.classList.remove('wrong');
        }, 300);
      }
    }

    function updateNumberInfo() {
      let numberInfoElement = elements.numberContainer.querySelector('.number-info');
      if (!numberInfoElement) {
        numberInfoElement = document.createElement('div');
        numberInfoElement.className = 'number-info';
        numberInfoElement.id = 'number-info';
        elements.numberContainer.insertBefore(numberInfoElement, elements.numberContainer.firstChild);
      }
      numberInfoElement.textContent = `다음 숫자: ${gameState.currentNumber}`;
    }

    // ========== 타이밍 모드 ==========
    function startTimingMode() {
      gameState.timingRound = 0;
      gameState.timingScores = [];
      gameState.paused = false;
      
      elements.container.className = 'waiting';
      elements.timingBar.classList.remove('paused');
      startTimingRound();
    }

    function startTimingRound() {
      gameState.timingRound++;
      elements.roundInfo.textContent = `라운드: ${gameState.timingRound}/${gameState.timingMaxRounds}`;
      elements.timingInfo.textContent = `라운드: ${gameState.timingRound}/${gameState.timingMaxRounds}`;
      
      // 바 애니메이션 재시작
      elements.timingBar.style.animation = 'none';
      elements.timingBar.classList.remove('paused');
      setTimeout(() => {
        if (!gameState.paused) {
          elements.timingBar.style.animation = 'moveBar 2s linear infinite';
        }
      }, 10);
    }

    function handleTimingClick() {
      if (gameState.paused) return;
      
      addClickEffect();
      
      // 바의 현재 위치 계산
      const bar = elements.timingBar;
      const container = bar.parentElement;
      const barRect = bar.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      
      const barCenter = barRect.left + barRect.width / 2 - containerRect.left;
      const containerCenter = containerRect.width / 2;
      const distance = Math.abs(barCenter - containerCenter);
      
      // 점수 계산 (0-100)
      const maxDistance = containerRect.width / 2;
      const score = Math.max(0, Math.round(100 - (distance / maxDistance) * 100));
      
      gameState.timingScores.push(score);
      
      // 점수 표시
      elements.timingScoreDisplay.textContent = `${score}점!`;
      elements.timingScoreDisplay.classList.remove('show');
      setTimeout(() => {
        elements.timingScoreDisplay.classList.add('show');
      }, 10);
      
      // 다음 라운드 또는 결과
      if (gameState.timingRound < gameState.timingMaxRounds) {
        setTimeout(() => {
          startTimingRound();
        }, 1000);
      } else {
        setTimeout(() => {
          showResult();
        }, 1500);
      }
    }

    // 게임 중 재시작
    function restartDuringGame() {
      clearTimeout(gameState.waitTimeout);
      clearTimeout(gameState.signalTimeout);
      elements.recordsBox.style.display = 'none';
      gameState.paused = false;
      elements.pauseModal.classList.remove('active');
      
      // 숫자 모드 정리
      const existingNumbers = elements.numberContainer.querySelectorAll('.number-item');
      existingNumbers.forEach(num => num.remove());
      
      // 타이밍 바 정리
      elements.timingBar.style.animation = 'none';
      elements.timingBar.classList.remove('paused');
      
      startGame();
    }

    // 일시정지
    function pauseGame() {
      if (gameState.paused) return;
      
      gameState.paused = true;
      gameState.pausedTime = Date.now();
      
      // 타이머 일시정지
      if (gameState.waitTimeout) {
        clearTimeout(gameState.waitTimeout);
      }
      if (gameState.signalTimeout) {
        clearTimeout(gameState.signalTimeout);
      }
      
      // 타이밍 모드 바 일시정지
      if (gameState.mode === 'timing') {
        elements.timingBar.classList.add('paused');
      }
      
      elements.pauseModal.classList.add('active');
    }

    // 게임 재개
    function resumeGame() {
      gameState.paused = false;
      elements.pauseModal.classList.remove('active');
      
      if (gameState.mode === 'classic') {
        // 대기 중이었다면 다시 시작
        if (gameState.waiting) {
          startRound();
        }
        // 신호 표시 중이었다면 다시 표시
        else if (gameState.canClick) {
          showSignal();
        }
      } else if (gameState.mode === 'timing') {
        // 타이밍 바 애니메이션 재개
        elements.timingBar.classList.remove('paused');
      }
    }

    // 일시정지에서 메인으로
    function pauseToMain() {
      clearTimeout(gameState.waitTimeout);
      clearTimeout(gameState.signalTimeout);
      gameState.paused = false;
      elements.pauseModal.classList.remove('active');
      goToMain();
    }

    // 게임 중 메뉴로
    function goToMenuDuringGame() {
      clearTimeout(gameState.waitTimeout);
      clearTimeout(gameState.signalTimeout);
      gameState.paused = false;
      goToMain();
    }

    // 이벤트 리스너
    elements.startBtn.addEventListener('click', startGame);
    elements.retryBtn.addEventListener('click', restart);
    elements.mainBtn.addEventListener('click', goToMain);
    elements.restartBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      restartDuringGame();
    });
    elements.pauseBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      pauseGame();
    });
    elements.menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      goToMenuDuringGame();
    });
    elements.resumeBtn.addEventListener('click', resumeGame);
    elements.pauseMenuBtn.addEventListener('click', pauseToMain);
    elements.errorRetryBtn.addEventListener('click', retryAfterError);
    elements.gameScreen.addEventListener('click', handleClick);

    // 키보드 단축키
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' || e.key === 'R') {
        if (elements.resultModal.classList.contains('active')) {
          restart();
        } else if (elements.gameScreen.classList.contains('active') && !gameState.paused) {
          restartDuringGame();
        }
      }
      if (e.key === ' ' || e.key === 'Enter') {
        if (elements.gameScreen.classList.contains('active') && !gameState.paused) {
          handleClick();
        } else if (elements.pauseModal.classList.contains('active')) {
          resumeGame();
        }
      }
      if (e.key === 'Escape') {
        if (elements.gameScreen.classList.contains('active') && !gameState.paused) {
          pauseGame();
        } else if (elements.pauseModal.classList.contains('active')) {
          resumeGame();
        }
      }
      if (e.key === 'p' || e.key === 'P') {
        if (elements.gameScreen.classList.contains('active')) {
          if (gameState.paused) {
            resumeGame();
          } else {
            pauseGame();
          }
        }
      }
    });

    // 초기화
    displayBestRecord();
  </script>
</body>
</html>
